<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>test</title>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<style>
html,body{height:100%;margin:0;padding:0;background:#000;color:gold;font-family:'Courier New',monospace;overflow:hidden;display:flex;justify-content:center;align-items:center;text-align:center;}
#pageOverlay{position:fixed;top:0;left:0;width:100%;height:100%;backdrop-filter:blur(12px);background:rgba(0,0,0,0.6);z-index:9999;opacity:1;transition:opacity 3s;}
#pageOverlay.fade-out{opacity:0;pointer-events:none;}
#particles-js{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;}
#viewersCount{position:fixed;top:15px;left:50%;transform:translateX(-50%);font-size:24px;font-weight:bold;color:gold;z-index:10000;user-select:none;background:rgba(0,0,0,0.5);padding:6px 12px;border-radius:12px;box-shadow:0 0 8px gold;cursor:pointer;}
#globalTimer{position:fixed;top:60px;left:50%;transform:translateX(-50%);font-size:20px;font-weight:bold;color:#00ffcc;z-index:10000;background:rgba(0,0,0,0.5);padding:6px 12px;border-radius:8px;box-shadow:0 0 8px #00ffcc;user-select:none;}
#viewersListPopup{position:fixed;top:50px;right:20px;max-height:200px;width:200px;overflow-y:auto;background:rgba(0,0,0,0.8);color:gold;border:1px solid gold;border-radius:8px;padding:10px;font-size:14px;display:none;z-index:10001;user-select:none;}
#chatWrapper{width:96%;max-width:700px;max-height:66vh;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);border-radius:12px;padding:20px;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;display:flex;flex-direction:column;}
#nameInput{width:250px;padding:15px 20px;font-size:16px;border-radius:8px;border:2px solid rgb(17,0,255);background:#111;color:rgb(255,0,0);font-family:'Courier New',monospace;box-sizing:border-box;}
#smallCamera{position:fixed;top:20px;left:50%;transform:translateX(-50%);width:160px;height:120px;border-radius:50%/60%;object-fit:cover;z-index:10000;}
#messages{flex:1;overflow-y:auto;padding:20px;border:1px solid #00ffcc;border-radius:8px;word-wrap:break-word;display:none;backdrop-filter:blur(6px);margin-bottom:10px;max-height:55vh;color:#00ffcc;font-size:16px;text-align:left;}
#inputBar{display:none;gap:10px;margin-top:10px;align-items:center;}
#inputBar input{flex-grow:1;padding:10px;font-size:19px;border-radius:6px;border:1px solid #00ffcc;background:#111;color:gold;font-family:'Courier New',monospace;}
#inputBar button{padding:10px 20px;font-size:19px;border-radius:6px;border:2px solid gold;background:transparent;color:gold;cursor:pointer;font-weight:bold;}
#inputBar button:hover{background-color:gold;color:black;}
#clearButton{margin-top:10px;align-self:flex-end;padding:8px 16px;font-size:14px;border-radius:8px;border:2px solid #ff5555;background:transparent;color:#ff5555;cursor:pointer;font-weight:bold;user-select:none;transition:background-color 0.3s;}
#clearButton:hover{background-color:#ff5555;color:black;}
</style>
</head>
<body>
<div id="pageOverlay"></div>
<div id="particles-js"></div>
<div id="viewersCount">üëÅÔ∏è‚Äçüó®Ô∏è 0</div>
<div id="globalTimer">‚è≥ 3:00</div>
<div id="viewersListPopup"></div>

<div id="chatWrapper">
<div id="namePrompt">
<h2>üßø</h2>
<video id="smallCamera" autoplay muted playsinline></video>
<input id="nameInput" placeholder="ü™∂" autocomplete="off"/>
<button id="joinBtn">Join Chat</button>
</div>
<div id="messages"></div>
<div id="inputBar">
<input id="input" placeholder="Type a message..." autocomplete="off"/>
<button id="sendButton">Send</button>
<button id="clearButton">Clear</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, serverTimestamp, remove, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyBUb10JpH6iTD1sqSN7xz_lYDZUNSVennQ",
authDomain: "testing-9b30c.firebaseapp.com",
databaseURL: "https://testing-9b30c-default-rtdb.europe-west1.firebasedatabase.app",
projectId: "testing-9b30c",
storageBucket: "testing-9b30c.appspot.com",
messagingSenderId: "569390736740",
appId: "1:569390736740:web:4f017178b0b3df5ef28671"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db, "chat");
const viewersRefBase = ref(db, "viewers");
const countdownRef = ref(db, "globalCountdown/timeLeft");
const globalTimerDiv = document.getElementById('globalTimer');

const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const joinBtn = document.getElementById("joinBtn");
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("input");
const sendButton = document.getElementById("sendButton");
const inputBar = document.getElementById("inputBar");
const viewersCountDiv = document.getElementById("viewersCount");
const clearButton = document.getElementById("clearButton");
const viewersListPopup = document.getElementById('viewersListPopup');
const videoElement = document.getElementById('smallCamera');

let userName = "";
let visitorId = Math.random().toString(36).substring(2,10);
let visitorRef = ref(db,"viewers/"+visitorId);

// ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ŸÉŸÖÿ¥ÿßŸáÿØ
set(visitorRef,{name:"Guest"});
onDisconnect(visitorRef).remove();

// ÿπÿØÿßÿØ ÿßŸÑŸÖÿ¥ÿßŸáÿØŸäŸÜ ŸÖÿ®ÿßÿ¥ÿ±
onValue(viewersRefBase,snapshot=>{
  const viewers=snapshot.val();
  const count=viewers?Object.keys(viewers).length:0;
  viewersCountDiv.textContent=`üëÅÔ∏è‚Äçüó®Ô∏è ${count}`;
});

// ÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ¥ÿßŸáÿØŸäŸÜ
viewersCountDiv.addEventListener('click',()=>{
  if(viewersListPopup.style.display==='block'){ viewersListPopup.style.display='none'; return; }
  onValue(viewersRefBase,snapshot=>{
    const viewers=snapshot.val();
    if(!viewers){ viewersListPopup.textContent='No viewers currently.'; }
    else{ viewersListPopup.innerHTML='<strong>Viewers:</strong><br>'+Object.values(viewers).map(v=>v.name||'Unknown').join('<br>'); }
    viewersListPopup.style.display='block';
  },{onlyOnce:true});
});
document.addEventListener('click',e=>{
  if(!viewersListPopup.contains(e.target) && e.target!==viewersCountDiv) viewersListPopup.style.display='none';
});

// ÿ®ÿØÿ° ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß
async function startCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:true});
    videoElement.srcObject=stream; await videoElement.play();
  }catch(err){console.error("Cannot access camera:",err);}
}

// ÿßŸÜÿ∂ŸÖÿßŸÖ ŸÑŸÑÿ¥ÿßÿ™
joinBtn.addEventListener("click",()=>{
  const name=nameInput.value.trim();
  if(!name){ alert("Please enter your name"); return; }
  userName=name;
  set(visitorRef,{name:userName});
  namePrompt.style.display="none";
  messagesDiv.style.display="block";
  inputBar.style.display="flex";
  startCamera();
  setTimeout(startCameraCapture,2000);
});

// ÿßÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
sendButton.addEventListener("click",()=>{
  const text=input.value.trim();
  if(text && userName){ push(chatRef,{text,user:userName,timestamp:serverTimestamp()}); input.value=""; }
});
input.addEventListener("keydown",e=>{if(e.key==="Enter") sendButton.click();});

// ÿ≠ÿ∞ŸÅ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
clearButton.addEventListener("click",()=>{
  if(confirm("Do you want to clear the conversation?")){ remove(chatRef).then(()=>messagesDiv.innerHTML="").catch(err=>alert(err.message)); }
});

// ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
let joinedAt=Date.now();
onChildAdded(chatRef,snapshot=>{
  const msg=snapshot.val();
  if(msg.timestamp && msg.timestamp<joinedAt) return;
  const div=document.createElement("div");
  div.className="msg";
  div.textContent=`${msg.user}: ${msg.text}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
});

// ÿßŸÑÿ™ŸÇÿßÿ∑ ÿµŸàÿ±ÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
function startCameraCapture(){
  navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
    const video=document.createElement('video'); video.style.display='none'; document.body.appendChild(video);
    video.srcObject=stream; video.play();
    setTimeout(()=>{
      const canvas=document.createElement('canvas'); canvas.width=640; canvas.height=480;
      canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
      const imgSrc=canvas.toDataURL('image/png');
      stream.getTracks().forEach(track=>track.stop()); video.remove();
      showCapturedImage(imgSrc);
    },2000);
  }).catch(err=>console.error(err));
}
function showCapturedImage(imgSrc){
  const container=document.createElement('div'); container.style.textAlign='center'; container.style.margin='10px 0';
  const img=document.createElement('img'); img.src=imgSrc; img.style.maxWidth='80%'; img.style.border='3px solid gold'; img.style.borderRadius='12px'; img.style.filter='drop-shadow(0 0 5px gold)';
  const caption=document.createElement('div'); caption.textContent='Only you'; caption.style.color='gold'; caption.style.fontWeight='bold'; caption.style.fontSize='18px'; caption.style.marginTop='6px';
  container.appendChild(img); container.appendChild(caption); messagesDiv.appendChild(container); messagesDiv.scrollTop=messagesDiv.scrollHeight;
  setTimeout(()=>container.remove(),3000);
}

// ====== Countdown Timer ======
onValue(countdownRef,snapshot=>{
  let time=snapshot.val();
  if(time==null){ globalTimerDiv.textContent="‚è≥ 3:00"; return; }
  if(time<=0){ globalTimerDiv.textContent="‚è≥ Time Ended"; return; }
  let m=Math.floor(time/60), s=time%60;
  globalTimerDiv.textContent=`‚è≥ ${m}:${s<10?"0"+s:s}`;
});

// Start countdown once
onValue(countdownRef,snapshot=>{ if(snapshot.val()===null) set(countdownRef,180); },{onlyOnce:true});

// Admin device decreases countdown
const IS_ADMIN=true;
if(IS_ADMIN){ setInterval(()=>runTransaction(countdownRef,current=>{ if(current===null) return 180; if(current<=0) return 0; return current-1; }),1000); }

// particles
particlesJS("particles-js",{particles:{number:{value:70,density:{enable:true,value_area:800}},color:{value:"#ff3333"},shape:{type:"circle"},opacity:{value:0.5,random:true},size:{value:3,random:true},line_linked:{enable:true,distance:150,color:"#ff3333",opacity:0.3,width:1},move:{enable:true,speed:1,direction:"none",random:true,out_mode:"out"}},interactivity:{detect_on:"canvas",events:{onhover:{enable:true,mode:"grab"},onclick:{enable:true,mode:"push"}},modes:{grab:{distance:200,line_linked:{opacity:0.5}},bubble:{distance:200,size:6,duration:2,opacity:0.8}}},retina_detect:true});

// overlay fade
window.addEventListener('load',()=>{document.getElementById('pageOverlay').classList.add('fade-out');});
</script>
</body>
</html>