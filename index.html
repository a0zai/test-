<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Global Countdown</title>
<style>
  html, body {
    height: 100%; margin: 0; padding: 0;
    display: flex; justify-content: center; align-items: center;
    background-color: #000; font-family: 'Courier New', monospace;
    overflow: hidden; color: red;
  }
  #timerContainer {
    position: relative; width: 250px; height: 250px;
  }
  #timerCanvas {
    width: 100%; height: 100%;
  }
  #timerText {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px; font-weight: bold;
    color: red; text-align: center;
    text-shadow: 0 0 15px red;
  }
</style>
</head>
<body>
<div id="timerContainer">
  <canvas id="timerCanvas" width="250" height="250"></canvas>
  <div id="timerText">3:00</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, onValue, set, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyBUb10JpH6iTD1sqSN7xz_lYDZUNSVennQ",
  authDomain: "testing-9b30c.firebaseapp.com",
  databaseURL: "https://testing-9b30c-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "testing-9b30c",
  storageBucket: "testing-9b30c.appspot.com",
  messagingSenderId: "569390736740",
  appId: "1:569390736740:web:4f017178b0b3df5ef28671"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const countdownRef = ref(db,"globalCountdown/timeLeft");

// ===== Variables =====
const canvas = document.getElementById("timerCanvas");
const ctx = canvas.getContext("2d");
const timerText = document.getElementById("timerText");
const radius = canvas.width / 2 - 10;
let pulse = 0;
let pulseDirection = 0.05;

// ===== Alarm Sound =====
const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

// ===== Draw Timer Function =====
function drawTimer(percentage){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const r = radius + Math.sin(pulse)*5; 
  pulse += pulseDirection;

  // background circle
  ctx.beginPath();
  ctx.arc(canvas.width/2,canvas.height/2,r,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(80,0,0,0.3)';
  ctx.lineWidth = 12;
  ctx.stroke();

  // progress circle
  ctx.beginPath();
  ctx.arc(canvas.width/2,canvas.height/2,r,-Math.PI/2, -Math.PI/2 + Math.PI*2*percentage);
  ctx.strokeStyle = 'red';
  ctx.lineWidth = 12;
  ctx.shadowBlur = 20*(1-percentage);
  ctx.shadowColor = 'red';
  ctx.stroke();
}

// ===== Initialize Countdown =====
onValue(countdownRef, snapshot=>{
  let time = snapshot.val();
  if(time==null) { set(countdownRef, 180); time=180; }

  if(time<0) time=0;
  const m = Math.floor(time/60);
  const s = time%60;
  timerText.textContent = `${m}:${s<10?'0'+s:s}`;
  drawTimer(time/180);

  if(time===0){
    if(!alarmSound.played.length) alarmSound.play().catch(()=>{});
  }
});

// ===== Admin reduces countdown =====
const IS_ADMIN = true;
if(IS_ADMIN){
  setInterval(()=>{
    runTransaction(countdownRef,current=>{
      if(current===null) return 180;
      if(current<=0) return 0;
      return current-1;
    });
  },1000);
}

// ===== Smooth Pulse Animation =====
setInterval(()=>{
  const text = timerText.textContent;
  if(text.includes("0:00")) return;
  const match = text.match(/(\d+):(\d+)/);
  if(match){
    const minutes = parseInt(match[1]);
    const seconds = parseInt(match[2]);
    const totalSeconds = minutes*60 + seconds;
    drawTimer(totalSeconds/180);
  }
},50);
</script>
</body>
</html>