<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Scary Countdown Chat</title>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<style>
html, body {
  height: 100%; margin: 0; padding: 0;
  background-color: #000; color: gold;
  font-family: 'Courier New', monospace;
  overflow: hidden; display: flex; justify-content: center; align-items: center;
  text-align: center;
}

#pageOverlay {
  position: fixed; top:0; left:0; width:100%; height:100%;
  backdrop-filter: blur(12px); background-color: rgba(0,0,0,0.6);
  z-index:9999; opacity:1; transition: opacity 3s ease;
}
#pageOverlay.fade-out { opacity:0; pointer-events:none; }

#particles-js { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }

#globalTimerContainer {
  position: fixed; top:50%; left:50%;
  transform: translate(-50%,-50%);
  width: 250px; height: 250px; z-index:10000;
}
#globalTimerCanvas {
  width: 100%; height: 100%;
}
#globalTimerText {
  position: absolute; top:50%; left:50%;
  transform: translate(-50%,-50%);
  color: red; font-size: 48px; font-weight:bold; text-shadow:0 0 20px #ff0000;
  user-select: none;
}

#chatWrapper {
  width:96%; max-width:700px; max-height:66vh;
  background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
  border-radius:12px; padding:20px;
  position: fixed; bottom:20px; left:50%; transform: translateX(-50%);
  z-index:10; display:flex; flex-direction:column;
}
#nameInput { width:250px; padding:15px 20px; font-size:16px; border-radius:8px; border:2px solid rgb(17,0,255); background-color:#111; color:rgb(255,0,0); font-family:'Courier New', monospace; box-sizing:border-box; }
#smallCamera { position: fixed; top:20px; left:50%; transform:translateX(-50%); width:160px; height:120px; border-radius:50%/60%; object-fit:cover; z-index:10000;}
#messages { flex:1; overflow-y:auto; padding:20px; border:1px solid #00ffcc; border-radius:8px; word-wrap:break-word; display:none; backdrop-filter:blur(6px); margin-bottom:10px; max-height:55vh; color:#00ffcc; font-size:16px; text-align:left;}
#inputBar { display:none; gap:10px; margin-top:10px; align-items:center; }
#inputBar input { flex-grow:1; padding:10px; font-size:19px; border-radius:6px; border:1px solid #00ffcc; background-color:#111; color:gold; font-family:'Courier New', monospace; }
#inputBar button { padding:10px 20px; font-size:19px; border-radius:6px; border:2px solid gold; background:transparent; color:gold; cursor:pointer; font-weight:bold; }
#inputBar button:hover { background-color: gold; color:black; }
#clearButton { margin-top:10px; align-self:flex-end; padding:8px 16px; font-size:14px; border-radius:8px; border:2px solid #ff5555; background:transparent; color:#ff5555; cursor:pointer; font-weight:bold; user-select:none; transition:background-color 0.3s ease;}
#clearButton:hover { background-color:#ff5555; color:black;}
</style>
</head>
<body>

<div id="pageOverlay"></div>
<div id="particles-js"></div>

<div id="globalTimerContainer">
  <canvas id="globalTimerCanvas" width="250" height="250"></canvas>
  <div id="globalTimerText">3:00</div>
</div>

<div id="chatWrapper">
  <div id="namePrompt">
    <h2>ðŸ§¿</h2>
    <video id="smallCamera" autoplay muted playsinline></video>
    <input id="nameInput" placeholder="Your name" autocomplete="off" />
    <button id="joinBtn">Join Chat</button>
  </div>
  <div id="messages"></div>
  <div id="inputBar">
    <input id="input" placeholder="Type a message..." autocomplete="off" />
    <button id="sendButton">Send</button>
    <button id="clearButton">Clear</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, serverTimestamp, remove, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyBUb10JpH6iTD1sqSN7xz_lYDZUNSVennQ",
  authDomain: "testing-9b30c.firebaseapp.com",
  databaseURL: "https://testing-9b30c-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "testing-9b30c",
  storageBucket: "testing-9b30c.appspot.com",
  messagingSenderId: "569390736740",
  appId: "1:569390736740:web:4f017178b0b3df5ef28671"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const chatRef = ref(db,"chat");
const viewersRef = ref(db,"viewers");
const countdownRef = ref(db,"globalCountdown/timeLeft");

const namePrompt = document.getElementById("namePrompt");
const nameInput = document.getElementById("nameInput");
const joinBtn = document.getElementById("joinBtn");
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("input");
const sendButton = document.getElementById("sendButton");
const inputBar = document.getElementById("inputBar");
const clearButton = document.getElementById("clearButton");
const videoElement = document.getElementById("smallCamera");
const timerText = document.getElementById("globalTimerText");
const canvas = document.getElementById("globalTimerCanvas");
const ctx = canvas.getContext("2d");

let userName = "";
let visitorId = Math.random().toString(36).substring(2,10);
let visitorRef = ref(db,"viewers/"+visitorId);

// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø´Ø§Ù‡Ø¯
set(visitorRef,{name:"Guest"});
onDisconnect(visitorRef).remove();

// --- Ø¹Ø¯Ø§Ø¯ Ø´Ø§Øª ÙˆØ±Ø³Ø§Ø¦Ù„ ---
onValue(viewersRef, snapshot=>{
  const viewers = snapshot.val();
  // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ù„Ùˆ Ø£Ø­Ø¨Ø¨Øª
});

// --- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ---
async function startCamera(){ try{ const stream = await navigator.mediaDevices.getUserMedia({video:true}); videoElement.srcObject=stream; await videoElement.play(); } catch(err){console.error(err);} }

// --- Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø´Ø§Øª ---
joinBtn.addEventListener("click",()=>{
  const name=nameInput.value.trim(); if(!name){alert("Enter name"); return;}
  userName=name;
  set(visitorRef,{name:userName});
  namePrompt.style.display="none"; messagesDiv.style.display="block"; inputBar.style.display="flex";
  startCamera();
});

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
sendButton.addEventListener("click",()=>{
  const text=input.value.trim(); if(text&&userName){ push(chatRef,{text,user:userName,timestamp:serverTimestamp()}); input.value=""; }
});
input.addEventListener("keydown",e=>{if(e.key==="Enter") sendButton.click();});

// Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
clearButton.addEventListener("click",()=>{
  if(confirm("Clear chat?")){ remove(chatRef).then(()=>{messagesDiv.innerHTML=""}); }
});

// Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
let joinedAt = Date.now();
onChildAdded(chatRef, snapshot=>{
  const msg = snapshot.val();
  if(msg.timestamp && msg.timestamp<joinedAt) return;
  const div=document.createElement("div"); div.textContent=`${msg.user}: ${msg.text}`;
  messagesDiv.appendChild(div); messagesDiv.scrollTop=messagesDiv.scrollHeight;
});

// --- Countdown Timer ---
const TOTAL_SECONDS = 180;
const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆÙ‚Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
onValue(countdownRef,snap=>{ if(snap.val()===null) set(countdownRef,TOTAL_SECONDS); }, {onlyOnce:true});

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ù„ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
setInterval(()=>{ runTransaction(countdownRef,current=>{
  if(current===null) return TOTAL_SECONDS;
  if(current<=0) return 0;
  return current-1;
}); },1000);

// Ø±Ø³Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ
function drawCircle(percentage){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const radius = canvas.width/2 - 10;
  // Ø§Ù„Ø®Ù„ÙÙŠØ©
  ctx.beginPath(); ctx.arc(canvas.width/2,canvas.height/2,radius,0,Math.PI*2); ctx.strokeStyle="rgba(80,0,0,0.3)"; ctx.lineWidth=12; ctx.stroke();
  // Ø§Ù„ØªÙ‚Ø¯Ù…
  ctx.beginPath(); ctx.arc(canvas.width/2,canvas.height/2,radius,-Math.PI/2, -Math.PI/2 + 2*Math.PI*percentage); ctx.strokeStyle="red"; ctx.lineWidth=12; ctx.shadowBlur=10; ctx.shadowColor="red"; ctx.stroke();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯
onValue(countdownRef, snap=>{
  let time = snap.val(); if(time===null) time=TOTAL_SECONDS; if(time<0) time=0;
  const m=Math.floor(time/60); const s=time%60;
  timerText.textContent = `${m}:${s<10?'0'+s:s}`;
  const percent = time/TOTAL_SECONDS;
  drawCircle(percent);
  if(time===0 && !alarmSound.played.length) alarmSound.play().catch(()=>{});
});

// particles
particlesJS("particles-js",{particles:{number:{value:70,density:{enable:true,value_area:800}}, color:{value:"#ff3333"}, shape:{type:"circle"}, opacity:{value:0.5,random:true}, size:{value:3,random:true}, line_linked:{enable:true,distance:150,color:"#ff3333",opacity:0.3,width:1}, move:{enable:true,speed:1,direction:"none",random:true,out_mode:"out"}}, interactivity:{detect_on:"canvas", events:{onhover:{enable:true,mode:"grab"},onclick:{enable:true,mode:"push"}}, modes:{grab:{distance:200,line_linked:{opacity:0.5}},bubble:{distance:200,size:6,duration:2,opacity:0.8}}}, retina_detect:true });

// overlay fade
window.addEventListener('load',()=>{document.getElementById('pageOverlay').classList.add('fade-out');});
</script>
</body>
</html>